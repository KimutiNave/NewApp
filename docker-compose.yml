# docker-compose.yml example for https://github.com/ServerContainers/samba

services:
  db:
    image: postgres
    volumes:
      - /var/lib/postgresql/data
    restart: always
  web:
    build: .
    context: .
    secrets:
      master_key:
        file: ./rails/config/master.key
    volumes:
      - ${EB_LOG_BASE_DIR}/web:/var/log/app
        source: ./railsapp
        target: /railsapp
      - type: volume
        source: gemdata
        target: /usr/local/bundle
      - type: volume
        source: node_modules
        target: /railsapp/node_modules
    command:
      ["sh", "-c", "rm -f tmp/pids/server.pid; bin/rails server -p 3000 -b 0.0.0.0"]
    ports:
      - "3000:3000"
    env_file:
      - .env
  nginx:
    image: "nginx"
    ports:
      - "127.0.0.1:8080:80"
    # note that this network_mode makes it super easy (especially for zeroconf) but is not as safe as exposing ports directly
    # more about that here: https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation#hostnetwork
    #network_mode: host
    # uncomment to solve bug: https://github.com/ServerContainers/samba/issues/50 - wsdd2 only - not needed for samba
    #cap_add:
    #  - CAP_NET_ADMIN
    #environment:
      # uncomment to enable fail fast (currently only fails fast if there are conflicts/errors during user/group creation)
      #FAIL_FAST: 1

      
